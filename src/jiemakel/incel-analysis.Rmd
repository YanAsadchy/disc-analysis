---
title: "Incel analysis"
date: "`r Sys.Date()`"
output: 
  html_notebook:
    toc: yes
    code_folding: hide
  md_document:
    variant: gfm 
    toc: yes
---

```{r setup}
library(ggbeeswarm)
library(gt)
source(here::here("src/common_basis.R"))
```

# Post count distribution through time

```{r}
active_posters <- incel_posts_c %>%
  count(year=year(time_posted),month=month(time_posted), poster_id) %>%
  filter(n>3) %>%
  count(year, month, name="value") %>%
  mutate(name="active posters") %>%
  collect()
```

```{r}
incel_posts_c %>%
  group_by(year=year(time_posted),month=month(time_posted)) %>%
  summarise(posts=n(),users=n_distinct(poster_id), .groups="drop") %>%
  pivot_longer(posts:users) %>%
  collect() %>%
  union_all(active_posters) %>%
  mutate(month=as.Date(str_c(year,'-',month,'-01'))) %>%
  filter(month<"2023-03-01") %>%
  ggplot(aes(x=month,y=value)) +
  geom_line() +
  scale_y_continuous(labels=scales::number) + 
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  xlab("Month") +
  ylab("N") +
  theme_hsci_discrete() +
  facet_wrap(~name,scales="free_y",ncol=1)
```

# Post count distribution (overall/lounge)

```{r}
quantiles <- seq(0,1,by=0.05)
incel_users_c %>%
  select(user_total_posts) %>%
  collect() %>%
  reframe(
    quantile=quantiles,
    user_total_posts=quantile(user_total_posts,quantiles)
  ) %>%
  inner_join(
    incel_posts_c %>%
      count(poster_id) %>%
      select(n) %>%
      collect() %>%
      reframe(
        quantile=quantiles,
        user_lounge_posts=quantile(n,quantiles)
    ),
    join_by(quantile)
  ) %>%
  gt(rowname_col = "quantile") %>%
  fmt_percent(quantile, drop_trailing_zeros = TRUE) %>%
  fmt_number(columns = c(user_total_posts,user_lounge_posts), drop_trailing_zeros = TRUE)
```

 * As expected, the distribution is very skewed. Half the users have less than 100 posts, while the top 25% have more than 500. 

# Interaction between join date and total / lounge posts

```{r}
incel_users_c %>%
  filter(user_joined>"1970-01-01") %>%
  ggplot(aes(x=user_joined,y=user_total_posts)) +
  geom_point(size=0.5) +
  geom_smooth(method="lm", formula="y~x") +
  theme_hsci_discrete() +
  scale_y_continuous(labels=scales::number) +
  xlab("user join date") +
  ylab("Total posts") +
  ggtitle("Total posts")
```

```{r}
incel_posts_c %>%
  count(poster_id) %>%
  inner_join(incel_users_c, join_by(poster_id==user_id)) %>%
  filter(user_joined>"1970-01-01") %>%
  ggplot(aes(x=user_joined,y=n)) +
  geom_point(size=0.5) +
  geom_smooth(method="lm", formula="y~x") +
  theme_hsci_discrete() +
  scale_y_continuous(labels=scales::number) +
  xlab("user join date") +
  ylab("Lounge posts") +
  ggtitle("Lounge posts")
```

 * The earlier you join, the more likely you are to have more posts, but there doesn't seem to be a discernible pattern for when the real "heavy hitters" have joined.

# Board rhythm

```{r}
incel_posts_c %>% 
  mutate(hour=hour(time_posted),weekday=weekday(time_posted)) %>%
  count(weekday,hour) %>%
  ggplot(aes(x=hour,y=n,color=as_factor(weekday))) +
  geom_line() +
  theme_hsci_discrete() +
  theme(
    legend.justification = c(1, 0), 
    legend.position = c(0.98, 0.02), 
    legend.background = element_blank(), 
    legend.key = element_blank()) +
  xlab("Hour (UTC)") +
  ylab("Total number of posts") +
  labs(color="Day of the week") +
  ggtitle("Posts by the time of day")
```

```{r}
weekdays <- tribble(~index,~weekday,
                    0,"Mon",
                    1,"Tue",
                    2,"Wed",
                    3,"Thu",
                    4,"Fri",
                    5,"Sat",
                    6,"Sun")
incel_posts_c %>% 
  mutate(weekday=weekday(time_posted)) %>%
  count(weekday) %>%
  ggplot(aes(x=weekday,y=n)) +
  geom_col() +
  theme_hsci_discrete() +
  scale_x_continuous(breaks=weekdays$index, labels=weekdays$weekday) +
  scale_y_continuous(labels=scales::number) +
  xlab("Day of the week") +
  ylab("Total number of posts") +
  ggtitle("Posts by day of the week")
```


```{r}
user_type <- incel_posts_c %>%
  count(poster_id) %>%
  mutate(user_type=if_else(n>=100,"top","other")) %>%
  select(poster_id, user_type)

incel_posts_c %>% 
  mutate(hour=hour(time_posted)) %>%
  inner_join(user_type, join_by(poster_id)) %>%
  count(user_type,hour) %>%
  group_by(user_type) %>%
  mutate(proportion=n/sum(n)) %>%
  ungroup() %>%
  ggplot(aes(x=hour,y=proportion,color=user_type)) +
  geom_line() +
  theme_hsci_discrete() +
  theme(
    legend.justification = c(1, 0), 
    legend.position = c(0.98, 0.02), 
    legend.background = element_blank(), 
    legend.box.just = "bottom", 
    legend.key = element_blank(), 
    legend.box = "horizontal") +
  scale_y_continuous(labels=scales::percent_format(accuracy=1)) +
  xlab("Hour (UTC)") +
  ylab("Proportion of posts") +
  labs(color="user type") +
  ggtitle("Proportion of posts by the time of day of top/other users")
```

 * There doesn't seem to be a difference in daily rhythms between top users and others. 
 * Interestingly, no big differences by day of week
 * How international is the forum? 
 
## Are there distinct subpopulations?
 
```{r}
incel_posts_c %>% 
  mutate(hour=hour(time_posted)) %>%
  count(poster_id,hour) %>%
  group_by(poster_id) %>%
  filter(sum(n)>=100) %>% # limit to users with enough data to get any pattern
  mutate(proportion=n/sum(n)) %>%
  ungroup() %>%
  ggplot(aes(x=hour,y=proportion)) +
  geom_quasirandom(size=0.25) +
  coord_cartesian(ylim=c(0,0.25)) +
  theme_hsci_discrete() +
  scale_y_continuous(labels=scales::percent_format(accuracy=1)) +
  xlab("Hour (UTC)") +
  ylab("Proportion of posts") +
  labs(color="user type") +
  ggtitle("Proportion of posts by the time of day for each individual user")
```
 
  * There do not seem to be clearly distinct time profiles with large groups of users. There may be some variation in UTC night time posting behaviour (3-12 UTC)
  
# How long are people active by year joined

```{r}
incel_posts_c %>%
    group_by(poster_id) %>%
    summarise(earliest_post=min(time_posted),latest_post=max(time_posted), .groups="drop") %>%
    mutate(earliest_post_year=year(earliest_post), active_period_days=sql("timestampdiff(day,earliest_post,latest_post)")) %>%
  ggplot(aes(x=earliest_post_year,y=active_period_days)) + 
  geom_quasirandom(size=0.25) +
  theme_hsci_discrete() +
  xlab("Year of earliest post") +
  ylab("Time between earliest and latest post (days)") +
  ggtitle("Time between earliest and latest post by year joined")
```

 * In 2019, there seem to have been more people joining who stayed on longer.

# Different -cels
 
```{r}
cel_post_contents <- incel_posts_c %>% 
  filter(str_detect(post_content,"cels?\\b")) %>% 
  select(post_id, post_content) %>% 
  collect() 

cels_by_post <- cel_post_contents %>%
  mutate(cel=str_extract_all(post_content, "(?<! expand...)[^ \\n]+ cels?\\b|[^ \\n]*cels?\\b(?! said)")) %>%
  unnest(cel) %>% 
  filter(!str_detect(cel, "^@")) %>%
  select(post_id, cel) %>% 
  mutate(cel=cel %>% 
           str_to_lower() %>% 
           str_replace_all("\\W","") %>% 
           str_replace_all("s$",""))
```
 
 
```{r}
cels <- cels_by_post %>%
  count(cel) %>% 
  arrange(desc(n))
```
 
```{r}
cels %>% 
  write_tsv(here("data/output/jiemakel/cels.tsv"),na="",quote="needed")
```

```{r}
cels %>%
  head(n=100) %>%
  gt(rowname_col="cel") %>%
  fmt_integer(n)
```
 
```{r}
cels2 <- cels_by_post %>%
  filter(cel!="incel") %>%
  distinct() %>%
  group_by(post_id) %>%
  filter(n()>1) %>%
  arrange(cel) %>%
  summarise(cel=str_flatten(cel, collapse=", "), .groups="drop") %>%
  count(cel) %>% 
  arrange(desc(n))
```
 
```{r}
cels2 %>% 
  write_tsv(here("data/output/jiemakel/cels2.tsv"),na="",quote="needed")
```
 
```{r}
cels2 %>%
  head(n=100) %>%
gt(rowname_col="cel") %>%
  fmt_integer(n)
```
 
```{r}
trucel_posts <- cels_by_post %>% 
  filter(str_detect(cel,"tru")) %>%
  distinct(post_id)

fakecel_posts <- cels_by_post %>% 
  filter(str_detect(cel,"fake")) %>%
  distinct(post_id)
```
 
```{r}
cels_by_post %>% inner_join(trucel_posts, join_by(post_id)) %>%
  filter(!cel %in% c("trucel","truecel", "incel", "httpsincel")) %>%
  count(cel) %>%
  arrange(desc(n))

cels_by_post %>% inner_join(fakecel_posts, join_by(post_id)) %>%
  filter(!cel %in% c("fakecel","incel", "httpsincel")) %>%
  count(cel) %>%
  arrange(desc(n))
```

# You/we/they are
```{r}
are_post_contents <- incel_posts_c %>% 
  filter(str_detect(post_content,"(you|they|we)('re| are) ")) %>% 
  select(post_id, post_content) %>% 
  collect() %>%
  mutate(post_content = post_content %>% str_replace_all("Click to expand...",".") %>% str_replace_all("\\s+"," "))
```


```{r}
ares_by_post <- c(1:4) %>% 
  map_dfr(~are_post_contents %>%
    mutate(length= .x, are=str_extract_all(post_content, str_c("(you|they|we)('re| are)('nt| not)?( a| an| the)?", strrep(" \\w+",.x))))
  ) %>%  
  unnest(are) %>%
  select(post_id, are, length) %>%
  mutate(are=are %>% str_replace("'re"," are") %>% str_replace("'nt", " not")) %>%
  mutate(
    who=str_replace(are," .*",""), 
    are=str_replace(are, ".*? ",""),
    stem=str_replace(are, " [^ ]*$", "")
  ) %>%
  relocate(post_id, length, who, are)
ares_by_post
```


```{r}
ares_by_post_count <- ares_by_post %>%
  count(length, who, are, stem)
ares_by_post_count
```

```{r}
top_ares <- ares_by_post_count %>% 
  group_by(length, who) %>%
  slice_max(n,n=20) %>%
  ungroup()
```


```{r}
ares_by_post_count %>% 
  anti_join(top_ares, join_by(who, are==stem)) %>%
  anti_join(ares_by_post_count %>% mutate(length=length+1), join_by(who,are,length)) %>%
  select(-stem) %>%
  group_by(length, who) %>%
  slice_max(n,n=20) %>%
  mutate(order=row_number()) %>%
  ungroup() %>%
  filter(order<=20) %>%
  pivot_wider(id_cols=c("length","order"), names_from="who", values_from=c("are","n")) %>%
  relocate(are_they,n_they,are_we,n_we,are_you,n_you) %>%
  arrange(desc(length)) %>%
  gt(groupname_col = "length", rowname_col="order") %>%
  cols_label(
    are_they="They",
    n_they="N",
    are_we="We",
    n_we="N",
    are_you="You",
    n_you="N") %>%
  tab_style(
    style = list(
      cell_borders(
        sides = c("right"),
        style = "solid"
      )
    ),
    locations = cells_body(
      columns = c(n_we,n_you,n_they)
    )
  )
  
```

